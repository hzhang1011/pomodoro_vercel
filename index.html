<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>番茄钟 · Vercel 一键部署</title>
<style>
  :root{
    --bg:#0f1724; --card:#091126; --accent:#ff6b6b; --muted:#9aa4b2;
    --glass: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Helvetica Neue", Arial;
    background: linear-gradient(180deg,#071021 0%, #0b1a2a 100%);
    color:#e6eef6; display:flex; align-items:center; justify-content:center; height:100vh;
  }
  .wrap{width:min(760px,95%); padding:28px; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:14px; box-shadow:0 8px 30px rgba(2,6,23,0.7); display:grid; grid-template-columns:1fr 320px; gap:18px}
  @media (max-width:820px){ .wrap{grid-template-columns:1fr; padding:18px} }
  header{grid-column:1/-1; display:flex; align-items:center; justify-content:space-between; gap:12px}
  h1{margin:0;font-size:18px;letter-spacing:0.2px}
  .left{display:flex;align-items:center;gap:12px}
  .badge{background:var(--glass); padding:6px 10px; border-radius:999px; color:var(--muted); font-size:13px}
  .clock{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:12px; padding:26px; display:flex; flex-direction:column; align-items:center; gap:12px; min-height:220px}
  .time{font-size:64px; font-weight:700; letter-spacing:1px}
  .mode{display:flex; gap:8px; flex-wrap:wrap; justify-content:center}
  button.mode-btn{background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--muted); padding:8px 12px; border-radius:10px; cursor:pointer}
  button.mode-btn.active{border-color:var(--accent); color:#fff; box-shadow:0 6px 18px rgba(255,107,107,0.12)}
  .controls{display:flex; gap:8px; margin-top:6px}
  .btn{padding:10px 14px; border-radius:10px; border:0; cursor:pointer; font-weight:600}
  .btn.start{background:linear-gradient(90deg,var(--accent), #ff4b4b); color:white}
  .btn.pause{background:#1f2937; color:#e6eef6}
  .settings{background:var(--card); padding:16px; border-radius:12px; display:flex; flex-direction:column; gap:12px; height:100%}
  label{font-size:13px; color:var(--muted)}
  .row{display:flex; gap:8px; align-items:center}
  input[type=number]{width:80px; padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:inherit}
  .switch{margin-left:auto; display:flex; gap:8px; align-items:center}
  .small{font-size:13px; color:var(--muted)}
  footer{grid-column:1/-1; text-align:center; color:var(--muted); font-size:13px; margin-top:6px}
  .preset{display:flex; gap:6px; flex-wrap:wrap}
  .chip{padding:6px 10px; border-radius:999px; background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.02); cursor:pointer; color:var(--muted)}
  .link{color:var(--muted); text-decoration:none}
  .progress-ring{position:relative; width:160px; height:160px}
  svg{display:block}
  .center-label{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; flex-direction:column}
  .tiny{font-size:12px; color:var(--muted)}
</style>
</head>
<body>
<div class="wrap" role="application">
  <header>
    <div class="left">
      <h1>番茄钟（Vercel 一键部署版）</h1>
      <div class="badge">轻量 · 无依赖 · 支持本地存储</div>
    </div>
    <div class="right small">快捷键: 空格 开始/暂停 · R 重置</div>
  </header>

  <main class="clock" aria-live="polite">
    <div class="progress-ring" id="ringWrap" title="进度圈">
      <svg width="160" height="160" viewBox="0 0 120 120">
        <defs></defs>
        <circle cx="60" cy="60" r="52" stroke="rgba(255,255,255,0.06)" stroke-width="12" fill="none"></circle>
        <circle id="progress" cx="60" cy="60" r="52" stroke="url(#g)" stroke-width="12" fill="none" stroke-linecap="round"
                transform="rotate(-90 60 60)" stroke-dasharray="326.7" stroke-dashoffset="326.7"></circle>
        <defs>
          <linearGradient id="g" x1="0" x2="1"><stop offset="0" stop-color="#ff8a8a"/><stop offset="1" stop-color="#ff4b4b"/></linearGradient>
        </defs>
      </svg>
      <div class="center-label">
        <div id="timeDisplay" class="time">25:00</div>
        <div id="statusLabel" class="tiny">专注 (25 分钟)</div>
      </div>
    </div>

    <div class="mode" role="tablist" aria-label="模式选择" style="margin-top:8px">
      <button class="mode-btn active" data-mode="focus">专注</button>
      <button class="mode-btn" data-mode="short">短休息</button>
      <button class="mode-btn" data-mode="long">长休息</button>
    </div>

    <div class="controls">
      <button class="btn start" id="startBtn">开始</button>
      <button class="btn pause" id="pauseBtn" style="display:none">暂停</button>
      <button class="btn" id="resetBtn">重置</button>
      <div style="margin-left:auto" class="small">周期: <span id="cycleCount">0</span></div>
    </div>
  </main>

  <aside class="settings">
    <div>
      <label>时间设置（分钟）</label>
      <div class="row">
        <div>
          <div class="small">专注</div>
          <input type="number" id="focusMin" min="1" max="180" value="25">
        </div>
        <div>
          <div class="small">短休息</div>
          <input type="number" id="shortMin" min="1" max="60" value="5">
        </div>
        <div>
          <div class="small">长休息</div>
          <input type="number" id="longMin" min="1" max="60" value="15">
        </div>
      </div>
    </div>

    <div>
      <label>选项</label>
      <div class="row">
        <div class="switch"><input type="checkbox" id="autoStart" /><label for="autoStart" class="small">自动开始下一个阶段</label></div>
      </div>
      <div class="row">
        <div class="switch"><input type="checkbox" id="soundOn" checked /><label for="soundOn" class="small">结束提示音</label></div>
      </div>
      <div style="margin-top:8px">
        <div class="small">预设</div>
        <div class="preset">
          <div class="chip" data-preset="25-5-15">标准 25/5/15</div>
          <div class="chip" data-preset="50-10-20">深度 50/10/20</div>
          <div class="chip" data-preset="15-5-10">短时 15/5/10</div>
        </div>
      </div>
    </div>

    <div style="margin-top:auto">
      <div class="small">导出 / 导入 设置</div>
      <div style="display:flex; gap:8px; margin-top:6px">
        <button id="exportBtn" class="btn">导出</button>
        <button id="importBtn" class="btn">导入</button>
      </div>
      <div style="margin-top:8px; font-size:12px; color:var(--muted)">
        设置保存在本地 (localStorage)。部署到 Vercel 后即可作为在线番茄钟使用。
      </div>
    </div>
  </aside>

  <footer>
    <span>Made with ❤️ · 本项目无需后端 · 快捷键：空格开始/暂停 · 按 R 重置</span>
    <div style="margin-top:6px"><a class="link" href="https://vercel.com/new/git/external?repository-url=REPO_URL" target="_blank" rel="noopener">一键部署到 Vercel（请将 REPO_URL 换成你的仓库地址）</a></div>
  </footer>
</div>

<!-- 声音资源：内置简短 beep（base64）-->
<audio id="beep" src="data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAA..."></audio>

<script>
/* --- 简单番茄钟逻辑 --- */
const $ = sel => document.querySelector(sel);
const timeDisplay = $('#timeDisplay');
const statusLabel = $('#statusLabel');
const startBtn = $('#startBtn'), pauseBtn = $('#pauseBtn'), resetBtn = $('#resetBtn');
const focusMin = $('#focusMin'), shortMin = $('#shortMin'), longMin = $('#longMin');
const autoStart = $('#autoStart'), soundOn = $('#soundOn');
const cycleCountEl = $('#cycleCount');
const progress = document.getElementById('progress');
const beep = document.getElementById('beep');

let state = {
  mode: 'focus', // focus, short, long
  running: false,
  totalSec: 1500,
  remainSec: 1500,
  cycle: 0
};

function loadSettings(){
  const s = localStorage.getItem('pomodoro-settings');
  if(s){
    try{
      const obj = JSON.parse(s);
      focusMin.value = obj.focus || 25;
      shortMin.value = obj.short || 5;
      longMin.value = obj.long || 15;
      autoStart.checked = !!obj.auto;
      soundOn.checked = obj.sound!==false;
    }catch(e){}
  }
}

function saveSettings(){
  const obj = { focus:+focusMin.value, short:+shortMin.value, long:+longMin.value, auto:autoStart.checked, sound:soundOn.checked };
  localStorage.setItem('pomodoro-settings', JSON.stringify(obj));
}

function setMode(mode, resetTimer=true){
  state.mode = mode;
  document.querySelectorAll('.mode-btn').forEach(b=>b.classList.toggle('active', b.dataset.mode===mode));
  const mins = mode==='focus'? +focusMin.value : (mode==='short'? +shortMin.value : +longMin.value);
  const text = mode==='focus'? '专注' : (mode==='short'? '短休息' : '长休息');
  statusLabel.textContent = `${text} (${mins} 分钟)`;
  if(resetTimer){
    state.totalSec = mins*60;
    state.remainSec = state.totalSec;
    renderTime();
    updateProgress();
  }
  saveState();
}

function renderTime(){
  const mm = Math.floor(state.remainSec/60).toString().padStart(2,'0');
  const ss = (state.remainSec%60).toString().padStart(2,'0');
  timeDisplay.textContent = `${mm}:${ss}`;
}

function updateProgress(){
  const circumference = 2 * Math.PI * 52;
  const ratio = state.remainSec / state.totalSec || 0;
  const offset = circumference * (1 - ratio);
  progress.style.strokeDasharray = `${circumference}`;
  progress.style.strokeDashoffset = `${offset}`;
}

let tickInterval = null;
function startTimer(){
  if(state.running) return;
  state.running = true;
  startBtn.style.display='none';
  pauseBtn.style.display='';
  tickInterval = setInterval(()=>{
    state.remainSec--;
    if(state.remainSec<=0){
      // 结束
      state.remainSec = 0;
      renderTime(); updateProgress();
      stopTimer(false);
      handleEnd();
    } else {
      renderTime(); updateProgress();
    }
  },1000);
  saveState();
}

function stopTimer(pause=true){
  if(tickInterval) { clearInterval(tickInterval); tickInterval=null; }
  state.running = false;
  startBtn.style.display=''; pauseBtn.style.display='none';
  saveState();
}

function resetTimer(){
  setMode(state.mode, true);
  stopTimer(false);
}

function handleEnd(){
  // 播放声音
  if(soundOn.checked){
    try{ beep.currentTime=0; beep.play(); }catch(e){}
  }
  // 如果是专注结束 -> 增加周期计数
  if(state.mode==='focus'){
    state.cycle = (state.cycle || 0) + 1;
    cycleCountEl.textContent = state.cycle;
  }
  // 自动切换逻辑：每 4 次专注后进入长休息
  const cycles = state.cycle || 0;
  if(state.mode==='focus'){
    if(cycles % 4 === 0){
      setMode('long', true);
    } else {
      setMode('short', true);
    }
  } else {
    setMode('focus', true);
  }
  // 自动开始下一个阶段？
  if(autoStart.checked){
    startTimer();
  }
  saveState();
}

function saveState(){
  const s = { ...state, settings: { focus:+focusMin.value, short:+shortMin.value, long:+longMin.value, auto:autoStart.checked, sound:soundOn.checked } };
  localStorage.setItem('pomodoro-state', JSON.stringify(s));
  saveSettings();
}

function loadState(){
  const s = localStorage.getItem('pomodoro-state');
  if(s){
    try{
      const obj = JSON.parse(s);
      if(obj.settings){
        focusMin.value = obj.settings.focus || focusMin.value;
        shortMin.value = obj.settings.short || shortMin.value;
        longMin.value = obj.settings.long || longMin.value;
        autoStart.checked = !!obj.settings.auto;
        soundOn.checked = obj.settings.sound!==false;
      }
      state.mode = obj.mode || 'focus';
      state.cycle = obj.cycle || 0;
      const mins = (state.mode==='focus'? +focusMin.value : (state.mode==='short'? +shortMin.value : +longMin.value));
      state.totalSec = mins*60;
      state.remainSec = typeof obj.remainSec === 'number' ? obj.remainSec : state.totalSec;
      cycleCountEl.textContent = state.cycle;
    }catch(e){}
  }
}

document.addEventListener('visibilitychange', ()=>{
  // 防止页面切换时 setInterval 变慢：不做复杂处理，这个简单版依赖定时器
});

document.addEventListener('keydown', (e)=>{
  if(e.code==='Space'){ e.preventDefault(); if(state.running) stopTimer(true); else startTimer(); }
  if(e.key==='r' || e.key==='R'){ resetTimer(); }
});

document.querySelectorAll('.mode-btn').forEach(b=>{
  b.addEventListener('click', ()=> setMode(b.dataset.mode, true));
});

startBtn.addEventListener('click', startTimer);
pauseBtn.addEventListener('click', ()=> stopTimer(true));
resetBtn.addEventListener('click', ()=> { resetTimer(); state.cycle=0; cycleCountEl.textContent=0; saveState(); });

[focusMin, shortMin, longMin, autoStart, soundOn].forEach(el=>{
  el.addEventListener('change', ()=> {
    setMode(state.mode, true);
    saveSettings();
  });
});

// 预设按钮
document.querySelectorAll('.chip').forEach(c=>{
  c.addEventListener('click', ()=>{
    const parts = c.dataset.preset.split('-').map(Number);
    focusMin.value = parts[0]; shortMin.value = parts[1]; longMin.value = parts[2];
    setMode('focus', true);
    saveSettings();
  });
});

// 导出 / 导入
$('#exportBtn').addEventListener('click', ()=>{
  const data = { settings: { focus:+focusMin.value, short:+shortMin.value, long:+longMin.value, auto:autoStart.checked, sound:soundOn.checked }, state };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download = 'pomodoro-settings.json'; document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
});
$('#importBtn').addEventListener('click', ()=>{
  const input = document.createElement('input'); input.type='file'; input.accept='application/json';
  input.onchange = ()=> {
    const f = input.files[0]; if(!f) return;
    const r = new FileReader();
    r.onload = ()=> {
      try{
        const obj = JSON.parse(r.result);
        if(obj.settings){
          focusMin.value = obj.settings.focus || focusMin.value;
          shortMin.value = obj.settings.short || shortMin.value;
          longMin.value = obj.settings.long || longMin.value;
          autoStart.checked = !!obj.settings.auto;
          soundOn.checked = obj.settings.sound!==false;
          setMode('focus', true);
          saveSettings();
          alert('导入成功');
        } else alert('文件格式不正确');
      }catch(e){ alert('导入失败：' + e.message) }
    };
    r.readAsText(f);
  };
  input.click();
});

function init(){
  loadSettings();
  loadState();
  setMode(state.mode, true);
  renderTime();
  updateProgress();
  if(state.running){
    // 如果之前处于运行，我们不自动重新开启计时，避免惊吓用户
    stopTimer(false);
  }
}
init();
/* end */
</script>
</body>
</html>